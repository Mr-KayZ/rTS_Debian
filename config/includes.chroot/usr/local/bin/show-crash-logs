#!/bin/bash
# show-crash-logs - Display recent system errors for troubleshooting

clear
echo "==============================================="
echo "  rTS Debian - System Crash Log Viewer"
echo "==============================================="
echo ""

# Check if running with sudo for full access
if [ "$EUID" -ne 0 ]; then
    echo "Note: Some logs require root access. Run with sudo for complete output."
    echo ""
fi

echo "=== Recent Kernel Errors (last 50 lines) ==="
echo ""
dmesg --color=always --level=err,crit,alert,emerg --time-format=iso | tail -50
echo ""

echo "=== Recent System Journal Errors (last 30 entries) ==="
echo ""
journalctl -p err -n 30 --no-pager --output=short-precise
echo ""

echo "=== Hardware/Driver Errors ==="
echo ""
journalctl -k -p err -n 20 --no-pager
echo ""

# Check for common crash indicators
if dmesg | grep -qi "segfault\|kernel BUG\|oops\|Call Trace"; then
    echo "WARNING: Kernel crashes detected!"
    echo ""
    echo "=== Kernel Crash Details ==="
    dmesg | grep -A 20 -i "segfault\|kernel BUG\|oops\|Call Trace" | tail -50
    echo ""
fi

# Check for GPU/Xorg crashes
if [ -f /var/log/Xorg.0.log ]; then
    if grep -qi "error\|fail\|crash\|segmentation fault" /var/log/Xorg.0.log 2>/dev/null; then
        echo "=== GPU/Display Errors ==="
        echo ""
        grep -i "error\|fail\|crash\|segmentation fault" /var/log/Xorg.0.log 2>/dev/null | tail -20
        echo ""
    fi
fi

# Check for out of memory issues
if dmesg | grep -qi "out of memory\|oom"; then
    echo "=== Out of Memory Errors ==="
    echo ""
    dmesg | grep -i "out of memory\|oom" | tail -20
    echo ""
fi

# Check for disk errors
if dmesg | grep -qi "I/O error\|ata.*error\|blk.*error"; then
    echo "=== Disk I/O Errors ==="
    echo ""
    dmesg | grep -i "I/O error\|ata.*error\|blk.*error" | tail -20
    echo ""
fi

echo "==============================================="
echo ""
echo "To save these logs to USB drive:"
echo "   show-crash-logs > /mnt/usb/crash_log.txt"
echo ""
echo "To export all logs for forum posting:"
echo "   emergency-log-export"
echo ""
echo "To view full system log:"
echo "   journalctl -b | less"
echo ""
echo "For kernel panics: Take photo of screen"
echo "==============================================="

# Pause if not piped
if [ -t 1 ]; then
    echo ""
    read -p "Press Enter to exit..."
fi
